rules_version = '2';

service cloud.firestore {
    match /databases/{database}/documents {

        function isEmail(email){
            return !(email in request.resource.data) || email is string && email.matches("^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$")
        }
        function isListLengthValid(data,fieldName,length){
            return !(fieldName in data) || (data[fieldName] is list && data[fieldName].size() <= length)
        }
        function isStringLengthValid(data,fieldName,length){
            return !(fieldName in data) || (data[fieldName] is string && data[fieldName].size() <= length)
        }        
        match /users/{userUid} {
                allow read: if request.auth.uid == userUid ;
                allow write: if request.auth.uid == userUid && isEmail(request.resource.data.email) && isListLengthValid(request.resource.data,"templates",5) && isStringLengthValid(request.resource.data,"displayName",20)
        }
    }
}
